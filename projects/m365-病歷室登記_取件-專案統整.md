# M365 病歷室「登記 + 取件」閉環（Forms / Power Automate / SharePoint / Power Apps）— 專案統整

> 目標：用 **MRN（病歷號碼）+ Unit（單位）** 在同一份 SharePoint 清單中完成「登記」與「取件」配對更新，形成閉環。

---

## 0) 系統構成

- SharePoint List：**病歷室登記**
- 登記來源：Microsoft Forms（或 Power Apps 直接登記）
- 取件來源：Microsoft Forms（或 Power Apps 直接取件）
- 自動化：Power Automate（Create/Update item）
- App：Power Apps（Phone / Canvas）

---

## 1) SharePoint 清單欄位（重點）

### 1.1 欄位型態注意
- `ReceivedAt`：必須是 **日期與時間**，且 **不得有預設值**（避免登記時被污染為已取件）。

### 1.2 在 Power Automate 會用到的 internal name（Filter array / item() 比對）
- 病歷號碼（MRN）：`OData__x75c5__x6b77__x865f__x78bc_`
- 單位（Unit）：`OData__x55ae__x4f4d_`

> 備註：Flow 端 Filter array 建議用 internal name 精準比對，避免顯示名/中文路徑取不到。

### 1.3 在 Power Apps 可能會看到的欄位名
- 有些環境 `Title` 會紅（不可用）。
- 取欄位/Filter 時以 `OData__x...` 欄位為準，且 MRN 是數字欄位需 `Value()`/`Text()` 轉型。

---

## 2) Power Automate — 取件 Flow（Forms → SharePoint Update item）

### 2.1 動作順序（現況骨幹）
1) Trigger：當提交新的回應時（Forms）
2) 取得回應詳細資料（Forms）
3) 取得多個項目（SharePoint Get items）
4) 篩選陣列（Filter array）
5) 條件：`length=1`
   - True：Update item（**只更新取件欄位**，避免洗空）
   - False：Terminate Failed（寫明原因）

### 2.2 已知關鍵修正
- **移除 splitOn**：避免重複/空白筆
- Get items：Top Count 從 20 提升到 **100**（避免抓不到資料）
- Forms 取值必用 r-hash keys（不要用中文題目名路徑）

### 2.3 Forms（取件表單）取得回應詳細資料 body keys
- MRN：`rf74a84e5e7804be8a222caa8f7374367`
- 取件人：`ra262c3a9c3654135a8cb8113c0fb6c0c`
- 單位：`r3df245b9050842b8a2a6dbd17ab48082`

### 2.4 日期時間寫入建議
- 用 fx expression：`formatDateTime(utcNow(), 'yyyy-MM-ddTHH:mm:ssZ')`（含 Z 避免時區顯示偏移）

### 2.5 上線安全 Update 原則
- Update item 僅更新：Id、ReceivedAt、取件人、（若可）Status
- 其他欄位參數移除，避免 null 回寫洗掉原資料

---

## 3) Power Automate — 入庫/登記 Flow（Forms → SharePoint Create item）

### 3.1 原則
- 登記時 **不要寫 ReceivedAt**（該欄位專供取件）
- 若用 code view：expression 必須 `@...` 才會被執行
- 不可把 `outputs('取得回應詳細資料')?...` 當純文字塞進欄位

---

## 4) Power Apps（Canvas / Phone）

### 4.1 畫面
- `INDEX`：首頁
- `scrRegister`：登記
- `scrReceive`：取件

### 4.2 scrReceive（取件）核心做法

#### 4.2.1 Gallery
- 建議命名：`galPending`
- Items（MRN-only 穩定版；`Title` 可能不可用）：

```powerapps
With(
  { mrnText: Trim(txtMRN.Text) },
  Filter(
    '病歷室登記',
    IsBlank(mrnText) || Text(OData__x75c5__x6b77__x865f__x78bc_) = mrnText
  )
)
```

> 若需加 Unit：用 `txtUnit.Text` 並對 `OData__x55ae__x4f4d_` 做 `Upper(Trim(...))` 再比。

#### 4.2.2 取件按鈕（在 Gallery 外，用 Selected）
```powerapps
If(
  IsBlank(galPending.Selected.ID),
  Notify("請先點選一筆再取件", NotificationType.Error),
  Patch(
    '病歷室登記',
    galPending.Selected,
    {
      取件人: User().FullName,
      ReceivedAt: Now()
    }
  );
  Notify("取件完成", NotificationType.Success);
  Navigate(INDEX)
)
```

#### 4.2.3 返回按鈕
- 不用 `Back()`（預覽/無歷史常不動）
```powerapps
Navigate(INDEX)
```

### 4.3 scrRegister（登記）
- 病歷號碼輸入：`TextInput4`
- 單位輸入：`TextInput5`
- 數量輸入：`TextInput6`
- Radio：`RadioSample`（Items 用 `Table({Value:"..."},...)`）

### 4.4 成功回饋（做法 1：Notify + 回首頁）
- Patch 後加：
```powerapps
Notify("登記完成", NotificationType.Success);
Navigate(INDEX)
```

---

## 5) 條碼掃描（MRN）

> 目標：登記頁、取件頁各一個 Barcode scanner。

- 每頁各放一個掃描器：例如 `scnReceiveMRN` / `scnRegisterMRN`
- 實測提醒：桌面 Studio 預覽可能不完整，建議 **Save → Publish → 手機 Power Apps App** 實測。
- MRN 變數可用 `varMRN`，需初始化避免紅字：
  - `App.OnStart`：`Set(varMRN, "")`
  - 輸入框 Default：`Coalesce(varMRN, "")`

> OnScan 的輸出欄位（Value/參數）依租戶版本可能不同，務必以 IntelliSense / 手機實測為準。

---

## 6) 驗收清單（上線前）

1) Power Apps：登記新增 → SharePoint 新增成功（ReceivedAt 仍空）
2) Power Apps：取件 Patch → SharePoint 該筆 ReceivedAt/取件人 更新
3) Power Automate：Forms 取件 → 能精準命中同一筆（MRN+Unit）→ Update item 僅更新取件欄位
4) 權限：內部人員對清單具備新增/編輯權限

---

## 7) 常見坑
- `Title` 在 Power Apps 可能不可用（紅字）→ 改用 `OData__x...` 欄位
- Text vs Number 比較錯誤 → MRN 用 `Value()` 或 `Text()` 做型別轉換
- 單位比對失敗 → 先 `Upper(Trim())` 再比
- `Back()` 不動 → 用 `Navigate(INDEX)`
- Flow Filter array：where 必須是 expression token（常需 `@...`）
- Forms 取值：必用 `r<hash>` key
