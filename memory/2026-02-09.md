# 2026-02-09 Daily Notes

## ComfyUI 臉部修復設定完成 ✅

### 安裝完成
- **ComfyUI-Impact-Pack**（含 FaceDetailer, SEGSDetailer）
- **ComfyUI-Impact-Subpack**（提供 UltralyticsDetectorProvider）
- **ultralytics** Python 套件
- **GFPGAN**：`GFPGANv1.4.pth` → `facerestore_models/`
- **Face Detection Model**：`face_yolov8m.pt` → `ultralytics/bbox/`

### 最終 Workflow
- 使用 **FaceDetailer**（一站式修臉）
- Detector：**UltralyticsDetectorProvider**（`bbox/face_yolov8m.pt`）
- 已存為 `AI.json`
  - Windows：`C:\AI\ComfyUI_windows_portable\ComfyUI\user\default\workflows\AI.json`
  - Workspace 備份：`comfyui_face_fix.json`

### 建議參數（避免變臉）
- denoise: 0.35
- cfg: 6.5
- steps: 16

---

## Moltbook 註冊 🦞
- 帳號：`Pi_Canner`
- Profile：https://moltbook.com/u/Pi_Canner
- 狀態：`pending_claim`
- 驗證碼：`scuttle-HZ42`
- Claim URL：https://moltbook.com/claim/moltbook_claim_w2zSa_bPIgqtzsvhirXOS9m6514gxWSj
- API Key：已存 `moltbook_credentials.json`

### 驗證步驟
1. 在 X/Twitter 發包含驗證碼的貼文
2. 點 claim URL 完成驗證

---

## 技術筆記

### ComfyUI 8188 Port 被佔用
- `netstat -ano | findstr :8188` 找 PID
- `taskkill /PID <pid> /F` 關閉

### Impact-Pack 安裝注意
- `UltralyticsDetectorProvider` 不在 Impact-Pack 本體
- 需額外安裝 **ComfyUI-Impact-Subpack**
- pip install 前先關 ComfyUI（避免 `cv2.pyd` 權限錯誤）

### ComfyUI API
- 送單：`http://127.0.0.1:8188/prompt`
- 查結果：`/history`
- 輸出：`ComfyUI/output/`

---

## 記憶流程規則（2026-02-09）
- 流水帳/日記型記憶可自動整理，優先 `gpt-oss:20b`
- **禁止自動寫入 `MEMORY.md`**（僅用戶明確要求才更新）
- 建議流程：
  1) 原始事件先寫 `memory/YYYY-MM-DD.md`
  2) 交給 `gpt-oss:20b` 做摘要草稿/去重
  3) 永久記憶需人工確認後再寫入

---

## OpenClaw / 模型路由與自動化
- 模型路由已確認：
  - Primary：`google-antigravity/claude-opus-4-5-thinking`
  - Fallback：`openai-codex/gpt-5.3-codex` → `openai-codex/gpt-5.2-codex` → `openai-codex/gpt-5.2` → Sonnet → Ollama
- 已建立每 6 小時整理流水帳 cron：
  - Job：`memory-rollup-every-6h`
  - ID：`6b464b67-5f1c-434a-8737-320286152bd2`
  - 規則：只整理 `memory/*.md`，不動 `MEMORY.md`
- 已實測 Ollama `gpt-oss:20b` API 回應正常（200）

---

## ComfyUI（本地）進展
- 策略改為「本地 ComfyUI 優先」，Nano Banana 非預設
- 已完成自動啟動/健康檢查排程方向（降低手動開機）
- 已下載手部模型：`models/ultralytics/bbox/hand_yolov8n.pt`
- 工作流新增/調整：
  - `AI02_face_hand.json`（臉+手）
  - `AI03_best_8gb_stable.json`（8GB 穩定）
  - `AI03_hq_8gb.json`（高品質慢版）
- 未解問題：手部與身體比例仍需持續微調（已避開最嚴重縫合）

---

## M365（Forms → Power Automate → SharePoint）整合進度

### 目標與策略
- 場景：病歷室作業管理
- 策略：
  - 無帳號外包：Microsoft Forms（公開）
  - 有帳號外包/內部：Power Apps
  - 後端統一寫入 SharePoint 清單，Flow 負責 CaseID/時間戳/狀態

### 目前基礎建置
- SharePoint 站台：
  - 名稱：`病歷室365`
  - URL：`https://o365kmuh.sharepoint.com/sites/998235kmuh.org.tw`
- Flow `Forms_病歷室入庫` 已完成核心骨架：
  1. `當提交新的回應時`
  2. `取得回應詳細資料`
  3. `建立項目`（SharePoint）

### 清單與欄位現況（最新）
- 正式清單以 **`病歷室登記`** 為準
- 欄位已包含：`病歷號碼`、`單位`、`登記類型`、`登記人`、`數量`、`SubmittedAt`、`ReceivedAt`（另有 `標題`）
- `建立項目` 已恢復可見全欄（12/12）

### Mapping 進度
- 已綁定：
  - `標題` → 病歷號碼
  - `病歷號碼` → 病歷號碼
  - `單位` → 單位
  - `登記人` → 登記人
  - `SubmittedAt` → `utcNow()`
- 待完成：
  - `ReceivedAt`（目前有重複 token，需清為單一表達式）
  - `登記類型 Value`
  - `數量`
  - `CaseID`（需補 `Update item` 回寫）

### 已排除/已知阻塞
- 已修正儲存錯誤：`response_id` 曾被字串化且前置 `/`，造成 int32 驗證失敗
- Chrome Relay 在 SharePoint 分頁偶發 `tab not found`（Power Automate 分頁較穩）
- 清單已有測試資料且含重複/近重複（需後續清理）

### 下一步（固定順序）
1. 完成 `建立項目` 全欄位 mapping
2. 新增 `Update item` 回寫 `CaseID`
3. 用新 Forms 做端到端實測
4. 加入重複檢查（複合鍵）並清理測試重複資料

---

## M365 外部取件 Flow（病歷室取件）晚間進度
- 已確認並修正動作型別誤用：
  - 原本誤放 `取得項目 (Get item/單筆)`，導致需要 `識別碼`，且把 OData 條件塞進識別碼欄位。
  - 已改為正確 `取得多個項目 (Get items/多筆)`。
- `取得多個項目` 目前設定：
  - Site: `病歷室365 - https://o365kmuh.sharepoint.com/sites/998235kmuh.org.tw`
  - List: `病歷室登記`
  - Filter Query: `病歷號碼 eq '@{outputs(''取得回應詳細資料'')?[''body/病歷號碼'']}' and Status eq '已登記'`
- 下一個待完成節點：
  1) 在 `取得多個項目` 後新增 `Condition`
  2) 判斷式：`length(body('取得多個項目')?['value']) = 1`
  3) Yes 分支做 `更新項目`（取件人、PickedAt=utcNow()、Status=已取件）
  4) No 分支保留記錄（不更新）
- 操作風險/阻塞仍在：Power Automate 新設計器右側探索面板常卡住在連接器全清單，導致接管點擊不穩定，需持續「先完成一個節點就儲存」。
