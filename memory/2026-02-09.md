# 2026-02-09 Daily Notes

## 今日重點
- 完成 ComfyUI 臉部修復鏈路（Impact Pack + Subpack + GFPGAN + YOLO face detector）。
- 建立/確認記憶整理規則：**日記可自動整理；`MEMORY.md` 禁止自動更新**（需主對話明確要求）。
- 建立每 6 小時流水帳整理排程：`memory-rollup-every-6h`。
- Moltbook 帳號建立完成，等待 claim 驗證。
- M365（Forms → Power Automate → SharePoint）主流程可運作，但「取件流程」仍在穩定化除錯。

---

## ComfyUI 臉部修復（完成）
### 安裝與模型
- ComfyUI-Impact-Pack（FaceDetailer / SEGSDetailer）
- ComfyUI-Impact-Subpack（UltralyticsDetectorProvider）
- `ultralytics` Python 套件
- `GFPGANv1.4.pth`（`facerestore_models/`）
- `face_yolov8m.pt`（`models/ultralytics/bbox/`）

### 工作流與參數
- 最終採用：**FaceDetailer** 一站式修臉
- Detector：`bbox/face_yolov8m.pt`
- 已存 workflow：
  - `C:\AI\ComfyUI_windows_portable\ComfyUI\user\default\workflows\AI.json`
  - workspace 備份：`comfyui_face_fix.json`
- 建議參數（避免變臉）：
  - `denoise: 0.35`
  - `cfg: 6.5`
  - `steps: 16`

### 補充
- 8188 port 被佔用排查：`netstat -ano | findstr :8188` + `taskkill /PID <pid> /F`
- ComfyUI API：`/prompt`、`/history`，輸出在 `ComfyUI/output/`

---

## ComfyUI 本地策略（進行中）
- 策略改為：**本地 ComfyUI 優先**（Nano Banana 非預設）
- 新增模型：`models/ultralytics/bbox/hand_yolov8n.pt`
- 新增/調整 workflow：
  - `AI02_face_hand.json`
  - `AI03_best_8gb_stable.json`
  - `AI03_hq_8gb.json`
- 未解：手部與身體比例仍需微調（已避開最嚴重縫合）

---

## Moltbook
- 帳號：`Pi_Canner`
- Profile：<https://moltbook.com/u/Pi_Canner>
- 狀態：`pending_claim`
- Claim URL：<https://moltbook.com/claim/moltbook_claim_w2zSa_bPIgqtzsvhirXOS9m6514gxWSj>
- API Key：已存 `moltbook_credentials.json`
- 驗證步驟：
  1. 在 X/Twitter 發含驗證碼貼文
  2. 開啟 claim URL 完成驗證

---

## 記憶流程規則（已定版）
- 流水帳/日記型記憶：可自動整理（可用 `gpt-oss:20b`）
- **禁止自動寫入 `MEMORY.md`**（僅主對話明確要求時更新）
- 建議流程：
  1) 原始事件先寫 `memory/YYYY-MM-DD.md`
  2) 再做去重與結構化整理
  3) 永久記憶需人工確認後再寫入

---

## OpenClaw / 模型路由
- Primary：`google-antigravity/claude-opus-4-5-thinking`
- Fallback：`openai-codex/gpt-5.3-codex` → `openai-codex/gpt-5.2-codex` → `openai-codex/gpt-5.2` → Sonnet → Ollama
- 已建立 cron：
  - Job：`memory-rollup-every-6h`
  - ID：`6b464b67-5f1c-434a-8737-320286152bd2`
  - 規則：僅整理 `memory/*.md`，不動 `MEMORY.md`
- 已確認 Ollama `gpt-oss:20b` API 回應正常（HTTP 200）

---

## M365 整合（Forms → Power Automate → SharePoint）
### 場景與策略
- 場景：病歷室作業管理
- 路線：
  - 無帳號外部：Microsoft Forms（公開）
  - 有帳號外部/內部：Power Apps
  - 後端統一寫入 SharePoint 清單

### 基礎建置現況
- SharePoint 站台：`病歷室365`
  - URL：<https://o365kmuh.sharepoint.com/sites/998235kmuh.org.tw>
- Flow `Forms_病歷室入庫`：骨架完成（觸發 → 取回應 → 建立項目）
- 正式清單：`病歷室登記`
- 欄位已含：`病歷號碼`、`單位`、`登記類型`、`登記人`、`數量`、`SubmittedAt`、`ReceivedAt`、`標題`

### 入庫 Flow 欄位映射
- 已綁定：`標題`、`病歷號碼`、`單位`、`登記人`、`SubmittedAt=utcNow()`
- 待補：`ReceivedAt`（清理重複 token）、`登記類型 Value`、`數量`、`CaseID` 回寫

### 取件 Flow（重點阻塞）
- 已修正方向：`Get item`（單筆）→ **`Get items`（多筆）**
- 已確認不穩來源：
  1. OData 篩選欄位被污染拼接，導致語法失效
  2. 動態 token 偶發空值，查詢退化為空字串比對
  3. 顯示名稱/內部欄位名混用（曾出現欄位不存在）
- 已決策穩定方案：
  - `Get items` 先取資料
  - 以 **Data Operations / 篩選陣列** 做條件匹配（避開 OData 內部欄位名雷點）
- 目前流程骨幹：
  - 觸發 → 取回應 → Get items → 篩選陣列 → 條件（length=1）→ 更新項目
- 當前阻塞：Power Automate 偶發 `Cannot edit in read-only editor`

### 下一步（最短路徑）
1. 在 `篩選陣列` 完成 and 條件（Status=已登記、單位相等、Title 後3碼比對）
2. `條件` 改為 `length(body('篩選陣列')) = 1`
3. `更新項目.id` 用 `first(body('篩選陣列'))?['ID']`
4. 儲存 → 測試 → 檢查 run history
